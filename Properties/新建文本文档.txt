using Microsoft.Extensions.Configuration;
using Microsoft.Win32;
using System;
using System.IO;
using System.Reflection;

namespace LuckyStars.Utils
{
    public class StartupManager
    {
        private readonly string _registryKeyPath;
        private readonly string _registryKeyName;
        private readonly string _startupArguments;
        private readonly string _executablePath;

        public StartupManager(IConfiguration configuration)
        {
            // 从配置文件读取设置
            var settings = configuration.GetSection("LuckyStarsSettings:AutoStartSettings");
            _registryKeyPath = settings["RegistryKeyPath"] ?? "SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run";
            _registryKeyName = settings["RegistryKeyName"] ?? "LuckyStarsWallpaper";
            _startupArguments = settings["StartupArguments"] ?? "--minimized --autostart";
            
            // 获取应用程序路径
            _executablePath = Assembly.GetExecutingAssembly().Location;
            _executablePath = _executablePath.Replace(".dll", ".exe");
        }

        // 获取自启动状态
        public bool IsAutoStartEnabled()
        {
            using var key = Registry.CurrentUser.OpenSubKey(_registryKeyPath, false);
            return key?.GetValue(_registryKeyName) != null;
        }

        // 设置自启动状态
        public void SetAutoStart(bool enable)
        {
            using var key = Registry.CurrentUser.OpenSubKey(_registryKeyPath, true) ?? 
                           Registry.CurrentUser.CreateSubKey(_registryKeyPath);

            if (enable)
            {
                // 添加启动项
                key.SetValue(_registryKeyName, $"\"{_executablePath}\" {_startupArguments}");
            }
            else
            {
                // 移除启动项
                key.DeleteValue(_registryKeyName, false);
            }
        }
    }
}